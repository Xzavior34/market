<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  <title>Checkout - Mini Jumia</title>

Â  Â  <link rel="manifest" href="manifest.json">
Â  <link rel="icon" href="icon-192.png" sizes="192x192" type="image/png">
Â  <meta name="theme-color" content="#0d6efd" />
Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
Â  <link rel="apple-touch-icon" href="icon-192.png">

Â  Â  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

Â  <style>
Â  Â  body {
Â  Â  Â  background: linear-gradient(135deg, #0d6efd, #6610f2);
Â  Â  Â  min-height: 100vh;
Â  Â  Â  color: #fff;
Â  Â  Â  font-family: 'Segoe UI', sans-serif;
Â  Â  }
Â  Â  .checkout-card {
Â  Â  Â  background: rgba(255,255,255,0.1);
Â  Â  Â  padding: 2rem;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  max-width: 600px;
Â  Â  Â  margin: 2rem auto;
Â  Â  Â  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
Â  Â  }
Â  Â  .btn-primary {
Â  Â  Â  background: #6610f2;
Â  Â  Â  border: none;
Â  Â  }
Â  Â  .btn-primary:hover {
Â  Â  Â  background: #520dc2;
Â  Â  }
Â  Â  a { color: #fff; text-decoration: underline; }
Â  Â  .list-group-item { background: rgba(255,255,255,0.05); border: none; color: #fff; }
Â  </style>
</head>
<body>
Â  <div id="userArea" class="text-end p-2"></div>

Â  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
Â  Â  <div class="container-fluid">
Â  Â  Â  <a class="navbar-brand" href="index.html">ğŸ› Mini Jumia</a>
Â  Â  </div>
Â  </nav>

Â  <div class="checkout-card">
Â  Â  <h2 class="mb-4">ğŸ§¾ Checkout</h2>
Â  Â  <ul class="list-group mb-3" id="cartItems"></ul>
Â  Â  <p class="text-end"><strong>Total:</strong> â‚¦<span id="total">0</span></p>

Â  Â  <form id="checkoutForm">
Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  <label class="form-label">Name</label>
Â  Â  Â  Â  <input type="text" id="name" class="form-control" required />
Â  Â  Â  </div>
Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  <label class="form-label">Phone</label>
Â  Â  Â  Â  <input type="tel" id="phone" class="form-control" required />
Â  Â  Â  </div>
Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  <label class="form-label">Email</label>
Â  Â  Â  Â  <input type="email" id="email" class="form-control" required />
Â  Â  Â  </div>
Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  <label class="form-label">Address</label>
Â  Â  Â  Â  <textarea id="address" class="form-control" required></textarea>
Â  Â  Â  </div>
Â  Â  Â  <button type="submit" class="btn btn-primary w-100">Place Order</button>
Â  Â  </form>
Â  </div>

Â  Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
Â  Â  import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyCOgQW8DzFIU9sJXD0j09kFpEzOpocfrpM",
Â  Â  Â  authDomain: "mini-jumia-42773.firebaseapp.com",
Â  Â  Â  databaseURL: "https://mini-jumia-42773-default-rtdb.firebaseio.com",
Â  Â  Â  projectId: "mini-jumia-42773",
Â  Â  Â  storageBucket: "mini-jumia-42773.appspot.com",
Â  Â  Â  messagingSenderId: "641009946484",
Â  Â  Â  appId: "1:641009946484:web:23a692390add3827802621"
Â  Â  };

Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getDatabase(app);

Â  Â  // Load cart items
Â  Â  const cartItems = JSON.parse(localStorage.getItem("cart")) || [];
Â  Â  const cartList = document.getElementById("cartItems");
Â  Â  const totalElement = document.getElementById("total");
Â  Â  let total = 0;

Â  Â  if (cartItems.length === 0) {
Â  Â  Â  cartList.innerHTML = "<li class='list-group-item'>Your cart is empty.</li>";
Â  Â  } else {
Â  Â  Â  cartItems.forEach(item => {
Â  Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  Â  li.className = "list-group-item";
Â  Â  Â  Â  li.textContent = `${item.name} - â‚¦${item.price.toLocaleString()}`;
Â  Â  Â  Â  cartList.appendChild(li);
Â  Â  Â  Â  total += item.price;
Â  Â  Â  });
Â  Â  }
Â  Â  totalElement.textContent = total.toLocaleString();

Â  Â  // Handle checkout
Â  Â  document.getElementById("checkoutForm").addEventListener("submit", async function(e) {
Â  Â  Â  e.preventDefault();

Â  Â  Â  const name = document.getElementById("name").value.trim();
Â  Â  Â  const phone = document.getElementById("phone").value.trim();
Â  Â  Â  const email = document.getElementById("email").value.trim();
Â  Â  Â  const address = document.getElementById("address").value.trim();

Â  Â  Â  if (!name || !phone || !email || !address) {
Â  Â  Â  Â  return alert("âŒ Please fill in all fields.");
Â  Â  Â  }
      
      // ğŸ¯ FIXED LOGIC: Safely determining user ID
Â  Â  Â  const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
Â  Â  Â  let userID;

Â  Â  Â  if (loggedInUser && loggedInUser.uid) {
Â  Â  Â  Â  Â  // Use the Firebase UID if the user is logged in
Â  Â  Â  Â  Â  userID = loggedInUser.uid;
Â  Â  Â  } else if (email) {
Â  Â  Â  Â  Â  // Fallback: Use the provided email address for guest orders
Â  Â  Â  Â  Â  userID = email; 
Â  Â  Â  } else {
Â  Â  Â  Â  Â  // Last resort check, prevents pushing 'undefined'
Â  Â  Â  Â  Â  return alert("âŒ Could not determine user ID for the order.");
Â  Â  Â  }
      // ğŸ¯ END FIXED LOGIC

Â  Â  Â  const orderId = "ORD" + Date.now();

Â  Â  Â  const order = {
Â  Â  Â  Â  order_id: orderId,
Â  Â  Â  Â  user_id: userID, // Now using the guaranteed non-undefined userID
Â  Â  Â  Â  name,
Â  Â  Â  Â  phone,
Â  Â  Â  Â  email,
Â  Â  Â  Â  address,
Â  Â  Â  Â  items: cartItems,
Â  Â  Â  Â  total: total,
Â  Â  Â  Â  status: "Pending",
Â  Â  Â  Â  timestamp: new Date().toISOString()
Â  Â  Â  };

Â  Â  Â  try {
Â  Â  Â  Â  await push(ref(db, "orders"), order);
Â  Â  Â  Â  localStorage.removeItem("cart");
Â  Â  Â  Â  alert("âœ… Order placed successfully!");
Â  Â  Â  Â  window.location.href = "history.html";
Â  Â  Â  } catch(err) {
Â  Â  Â  Â  console.error("âŒ Order failed:", err);
Â  Â  Â  Â  alert("Something went wrong. Try again.");
Â  Â  Â  }
Â  Â  });
Â  </script>

Â  Â  <script>
Â  Â  const userArea = document.getElementById("userArea");
Â  Â  const user = JSON.parse(localStorage.getItem("loggedInUser"));
Â  Â  if (user) {
Â  Â  Â  userArea.innerHTML = `
Â  Â  Â  Â  ğŸ‘‹ Welcome, <strong>${user.username}</strong>
Â  Â  Â  Â  <button class="btn btn-sm btn-outline-danger ms-2" onclick="logout()">Logout</button>
Â  Â  Â  `;
Â  Â  }

Â  Â  function logout() {
Â  Â  Â  localStorage.removeItem("loggedInUser");
Â  Â  Â  window.location.href = "login.html";
Â  Â  }
Â  </script>

Â  Â  <script>
Â  Â  if ("serviceWorker" in navigator) {
Â  Â  Â  navigator.serviceWorker.register("service-worker.js")
Â  Â  Â  Â  .then(reg => console.log("âœ… Service Worker registered:", reg.scope))
Â  Â  Â  Â  .catch(err => console.error("âŒ SW registration failed:", err));
Â  Â  }
Â  </script>
</body>
</html>
