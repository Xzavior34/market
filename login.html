<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Login - Mini Jumia</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd" />
<link rel="icon" href="icon-192.png" type="image/png" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    background: linear-gradient(135deg, #0d6efd, #6610f2);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-family: 'Segoe UI', sans-serif;
  }
  .login-card {
    background: rgba(255, 255, 255, 0.1);
    padding: 2rem;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    width: 100%;
    max-width: 400px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  }
  .login-card h2 {
    margin-bottom: 1.5rem;
    text-align: center;
  }
  .btn-primary {
    background: #6610f2;
    border: none;
  }
  .btn-primary:hover {
    background: #520dc2;
  }
  a {
    color: #fff;
    text-decoration: underline;
  }
</style>
</head>
<body>
<div class="login-card">
  <h2>üîê Login to Mini Jumia</h2>
  <form id="loginForm">
    <div class="mb-3">
      <label class="form-label">Email</label>
      <input type="email" id="email" class="form-control" placeholder="Enter email address" required />
    </div>
    <div class="mb-3">
      <label class="form-label">Password</label>
      <input type="password" id="password" class="form-control" placeholder="Enter password" required />
    </div>
    <button type="submit" class="btn btn-primary w-100">Login</button>
  </form>
  <p class="mt-3 text-center">Don't have an account? <a href="register.html">Sign up</a></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, get, push, child } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
// üö® NEW: Import Firebase Authentication methods
import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";


// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCOgQW8DzFIU9sJXD0j09kFpEzOpocfrpM",
  authDomain: "mini-jumia-42773.firebaseapp.com",
  databaseURL: "https://mini-jumia-42773-default-rtdb.firebaseio.com",
  projectId: "mini-jumia-42773",
  storageBucket: "mini-jumia-42773.appspot.com",
  messagingSenderId: "641009946484",
  appId: "1:641009946484:web:23a692390add3827802621"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
// üö® NEW: Initialize Auth
const auth = getAuth(app); 


document.getElementById("loginForm").addEventListener("submit", async e => {
  e.preventDefault();

  const emailInput = document.getElementById("email").value.trim(); // Changed from 'username' to 'email'
  const passwordInput = document.getElementById("password").value.trim();

  try {
    let userData = null;

    // 1. üö® NEW: Use Firebase Auth to sign the user in securely
    const userCredential = await signInWithEmailAndPassword(auth, emailInput, passwordInput);
    const user = userCredential.user;
    
    const uid = user.uid;

    // 2. Fetch the user's profile data from Realtime DB (Allowed by Rule Set 2)
    // Rule Set 2 allows reading /users/UID
    const userSnapshot = await get(child(ref(db, 'users'), uid));

    if (userSnapshot.exists()) {
      const dbUser = userSnapshot.val();
      
      // Combine Firebase Auth UID with DB profile data
      userData = { 
        ...dbUser, 
        uid: uid, 
        email: user.email, 
        role: dbUser.role || "user" 
      };
    } else {
      // Should not happen if registration is done correctly
      console.warn("User authenticated but profile not found in DB.");
      userData = { uid: uid, email: user.email, role: "user" };
    }

    // 3. Save logged-in user locally
    localStorage.setItem("loggedInUser", JSON.stringify(userData));

    // 4. Log session to Firebase (Allowed by Rule Set 2: ".write": "auth != null")
    await push(ref(db, "sessions"), {
      uid: userData.uid,
      email: userData.email,
      role: userData.role,
      loginTime: new Date().toISOString()
    });

    alert("‚úÖ Login successful!");
    window.location.href = userData.role === "admin" ? "admin.html" : "index.html";

  } catch (err) {
    let errorMessage = "‚ùå Something went wrong. Try again later.";
    
    // Handle specific Firebase Auth errors
    if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
        errorMessage = "‚ùå Invalid email or password.";
    }
    
    console.error("Login error:", err);
    alert(errorMessage);
  }
});
</script>
</body>
</html>
